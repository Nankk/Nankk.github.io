shadow$provide.module$node_modules$node_forge$lib$task=function(global,require,module,exports){var forge=require("module$node_modules$node_forge$lib$forge");require("module$node_modules$node_forge$lib$debug");require("module$node_modules$node_forge$lib$log");require("module$node_modules$node_forge$lib$util");var sTasks={},sNextTaskId=0;forge.debug.set("forge.task","tasks",sTasks);var sTaskQueues={};forge.debug.set("forge.task","queues",sTaskQueues);var sStateTable={ready:{}};sStateTable.ready.stop=
"ready";sStateTable.ready.start="running";sStateTable.ready.cancel="done";sStateTable.ready.fail="error";sStateTable.running={};sStateTable.running.stop="ready";sStateTable.running.start="running";sStateTable.running.block="blocked";sStateTable.running.unblock="running";sStateTable.running.sleep="sleeping";sStateTable.running.wakeup="running";sStateTable.running.cancel="done";sStateTable.running.fail="error";sStateTable.blocked={};sStateTable.blocked.stop="blocked";sStateTable.blocked.start="blocked";
sStateTable.blocked.block="blocked";sStateTable.blocked.unblock="blocked";sStateTable.blocked.sleep="blocked";sStateTable.blocked.wakeup="blocked";sStateTable.blocked.cancel="done";sStateTable.blocked.fail="error";sStateTable.sleeping={};sStateTable.sleeping.stop="sleeping";sStateTable.sleeping.start="sleeping";sStateTable.sleeping.block="sleeping";sStateTable.sleeping.unblock="sleeping";sStateTable.sleeping.sleep="sleeping";sStateTable.sleeping.wakeup="sleeping";sStateTable.sleeping.cancel="done";
sStateTable.sleeping.fail="error";sStateTable.done={};sStateTable.done.stop="done";sStateTable.done.start="done";sStateTable.done.block="done";sStateTable.done.unblock="done";sStateTable.done.sleep="done";sStateTable.done.wakeup="done";sStateTable.done.cancel="done";sStateTable.done.fail="error";sStateTable.error={};sStateTable.error.stop="error";sStateTable.error.start="error";sStateTable.error.block="error";sStateTable.error.unblock="error";sStateTable.error.sleep="error";sStateTable.error.wakeup=
"error";sStateTable.error.cancel="error";sStateTable.error.fail="error";var Task=function(options){this.id=-1;this.name=options.name||"?";this.parent=options.parent||null;this.run=options.run;this.subtasks=[];this.error=!1;this.state="ready";this.blocks=0;this.userData=this.swapTime=this.timeoutId=null;this.id=sNextTaskId++;sTasks[this.id]=this};Task.prototype.debug=function(msg){forge.log.debug("forge.task",msg||"","[%s][%s] task:",this.id,this.name,this,"subtasks:",this.subtasks.length,"queue:",
sTaskQueues)};Task.prototype.next=function(name,subrun){"function"===typeof name&&(subrun=name,name=this.name);name=new Task({run:subrun,name:name,parent:this});name.state="running";name.type=this.type;name.successCallback=this.successCallback||null;name.failureCallback=this.failureCallback||null;this.subtasks.push(name);return this};Task.prototype.parallel=function(name,subrun){forge.util.isArray(name)&&(subrun=name,name=this.name);return this.next(name,function(task){task.block(subrun.length);for(var startParallelTask=
function(pname,pi){forge.task.start({type:pname,run:function(task){subrun[pi](task)},success:function(task$jscomp$0){task.unblock()},failure:function(task$jscomp$0){task.unblock()}})},i=0;i<subrun.length;i++)startParallelTask(name+"__parallel-"+task.id+"-"+i,i)})};Task.prototype.stop=function(){this.state=sStateTable[this.state].stop};Task.prototype.start=function(){this.error=!1;this.state=sStateTable[this.state].start;"running"===this.state&&(this.start=new Date,this.run(this),runNext(this,0))};
Task.prototype.block=function(n){this.blocks+="undefined"===typeof n?1:n;0<this.blocks&&(this.state=sStateTable[this.state].block)};Task.prototype.unblock=function(n){this.blocks-="undefined"===typeof n?1:n;0===this.blocks&&"done"!==this.state&&(this.state="running",runNext(this,0));return this.blocks};Task.prototype.sleep=function(n){this.state=sStateTable[this.state].sleep;var self=this;this.timeoutId=setTimeout(function(){self.timeoutId=null;self.state="running";runNext(self,0)},"undefined"===
typeof n?0:n)};Task.prototype.wait=function(cond){cond.wait(this)};Task.prototype.wakeup=function(){"sleeping"===this.state&&(cancelTimeout(this.timeoutId),this.timeoutId=null,this.state="running",runNext(this,0))};Task.prototype.cancel=function(){this.state=sStateTable[this.state].cancel;this.permitsNeeded=0;null!==this.timeoutId&&(cancelTimeout(this.timeoutId),this.timeoutId=null);this.subtasks=[]};Task.prototype.fail=function(next){this.error=!0;finish(this,!0);if(next)next.error=this.error,next.swapTime=
this.swapTime,next.userData=this.userData,runNext(next,0);else{if(null!==this.parent){for(next=this.parent;null!==next.parent;)next.error=this.error,next.swapTime=this.swapTime,next.userData=this.userData,next=next.parent;finish(next,!0)}this.failureCallback&&this.failureCallback(this)}};var start=function(task){task.error=!1;task.state=sStateTable[task.state].start;setTimeout(function(){"running"===task.state&&(task.swapTime=+new Date,task.run(task),runNext(task,0))},0)},runNext=function(task,recurse){var swap=
30<recurse||20<+new Date-task.swapTime,doNext=function(recurse){recurse++;if("running"===task.state)if(swap&&(task.swapTime=+new Date),0<task.subtasks.length){var subtask=task.subtasks.shift();subtask.error=task.error;subtask.swapTime=task.swapTime;subtask.userData=task.userData;subtask.run(subtask);subtask.error||runNext(subtask,recurse)}else finish(task),task.error||null===task.parent||(task.parent.error=task.error,task.parent.swapTime=task.swapTime,task.parent.userData=task.userData,runNext(task.parent,
recurse))};swap?setTimeout(doNext,0):doNext(recurse)},finish=function(task,suppressCallbacks){task.state="done";delete sTasks[task.id];null===task.parent&&(task.type in sTaskQueues?0===sTaskQueues[task.type].length?forge.log.error("forge.task","[%s][%s] task queue empty [%s]",task.id,task.name,task.type):sTaskQueues[task.type][0]!==task?forge.log.error("forge.task","[%s][%s] task not first in queue [%s]",task.id,task.name,task.type):(sTaskQueues[task.type].shift(),0===sTaskQueues[task.type].length?
delete sTaskQueues[task.type]:sTaskQueues[task.type][0].start()):forge.log.error("forge.task","[%s][%s] task queue missing [%s]",task.id,task.name,task.type),suppressCallbacks||(task.error&&task.failureCallback?task.failureCallback(task):!task.error&&task.successCallback&&task.successCallback(task)))};module.exports=forge.task=forge.task||{};forge.task.start=function(options){var task=new Task({run:options.run,name:options.name||"?"});task.type=options.type;task.successCallback=options.success||null;
task.failureCallback=options.failure||null;task.type in sTaskQueues?sTaskQueues[options.type].push(task):(sTaskQueues[task.type]=[task],start(task))};forge.task.cancel=function(type){type in sTaskQueues&&(sTaskQueues[type]=[sTaskQueues[type][0]])};forge.task.createCondition=function(){var cond={tasks:{},wait:function(task){task.id in cond.tasks||(task.block(),cond.tasks[task.id]=task)},notify:function(){var tmp=cond.tasks;cond.tasks={};for(var id in tmp)tmp[id].unblock()}};return cond}}
//# sourceMappingURL=module$node_modules$node_forge$lib$task.js.map
